<!DOCTYPE html>
<html lang="en">
	<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <title>Typing Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #5d8aab;
            color: white;
            font-family: Arial, sans-serif;
        }

        #cover {
            padding: 30px 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #inner {
            background-color: #004562;
            padding: 20px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h5, h3, h4, p {
            color: #fafafa;
        }

        #level {
            text-align: left;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .intro {
            text-align: center;
        }

        button {
            margin: 5px;
            background-color: #5d8aab;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        button:hover {
            background-color: #004562;
        }

        input {
            margin: 10px 0;
            text-align: center;
            background-color: #5d8aab;
            border: none;
            height: 40px;
            width: 100%;
            border-radius: 5px;
            color: white;
        }

        hr {
            width: 50%;
            border: 0.3px solid green;
            margin: 20px auto;
        }

        .username {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            button {
                width: 100%;
                margin-bottom: 10px;
            }

            #inner {
                padding: 15px;
            }

            input {
                font-size: 16px;
                height: 35px;
            }
        }

        /* Game Over Modal Style */
        .modal-backdrop.show {
            opacity: 0.5 !important;
        }
    </style>
	</head>
	<body>
    <div id="cover">
      <div id="inner">
        <header class="text-center">
          <div class="username" id="username-display"></div>
          <div id="level">Current Level: <span id="current-level"></span></div>
        </header>
        <button id="easy">easy üê∑</button>
        <button id="medium">medium üêº</button>
        <button id="hard">hard üî•</button>
        <br><br>

        <!-- Word input -->
        <p>Type the given word within <span class="text-success" id="seconds"></span> Seconds:</p>
        <h2 class="display-4 mb-3" id="current-word"></h2>
        <h4 class="mt-2" id="message"></h4>
        <input type="text" class="form-control form-control-lg" placeholder="Start typing..." id="word-input" autofocus>
				<hr/>

        <!-- Time & Score Columns -->
        <div class="row mt-2">
          <div class="col-md-6">
            <h3>Time Left: <span id="time">0</span></h3>
          </div>
          <div class="col-md-6">
            <h3>Score: <span id="score">0</span></h3>
          </div>
          <div class="col-md-12">
            <h4>High score: <span id="high-score">0</span></h4>
          </div>
        </div>
        <input type="text" placeholder="Pro Tip: Sometimes it's faster to delete all and just retype!" id="input2" disabled>

        <!-- Game Action Section -->
        <div class="mt-4">
          <button onclick="showModal()">Submit Score</button>
            <a href="leaderboard.html" class="btn btn-secondary">View Leaderboard</a>
          <button onclick="logout()" class="btn btn-danger">Logout</button>
        </div>
      </div>
    </div>
    
    <!-- Username Modal -->
    <div id="usernameModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3);">
      <h3>Enter your username:</h3>
      <input type="text" id="usernameInput" placeholder="Username">
      <button onclick="submitUsername()">Submit</button>
      <button onclick="closeModal()">Cancel</button>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:gray; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3);">
      <h3>Game Over üòë</h3>
      <p>Your final score is: <span id="final-score">0</span></p>
      <button onclick="startAgain()">Start Again</button>
      <button onclick="closeGameOverModal()">Close</button>
    </div>

    <script>
      window.addEventListener('load', init);

			// Available Levels
			const levels = {
					easy: 5,
					medium: 3,
					hard: 2
			};

			const words = [
				'grid', 'swift', 'rails', 'ruby', 'python', 'java', 'tech', 'clear', 'echo', 'let',
				'wall', 'laughter', 'hash', 'kotlin', 'mobile', 'android', 'javascript', 'web', 'program',
				'coding', 'basic', 'foodie', 'work', 'case', 'react', 'dragon', 'rush', 'api', 'virtual',
				'nerd', 'google', 'float', 'docker', 'block', 'rank', 'class', 'machine', 'perfect',
				'deploy', 'terminal', 'array', 'vue', 'node', 'issue', 'front', 'grid', 'geek', 'mac',
				'console', 'clone', 'heroku', 'slack', 'version', 'control', 'data', 'npm', 'developer'
			];

			let currentLevel = levels.easy;
			let time = currentLevel;
			let score = 0;
			let isPlaying = false;
			let timer;

			// DOM Elements
			const wordInput = document.querySelector('#word-input');
			const currentWord = document.querySelector('#current-word');
			const scoreDisplay = document.querySelector('#score');
			const timeDisplay = document.querySelector('#time');
			const message = document.querySelector('#message');
			const seconds = document.querySelector('#seconds');
			const highScoreElt = document.querySelector('#high-score');
			const easyBtn = document.querySelector('#easy');
			const mediumBtn = document.querySelector('#medium');
			const hardBtn = document.querySelector('#hard');
			const levelDisplay = document.querySelector('#current-level');
			const usernameDisplay = document.querySelector('#username-display');
			const gameOverModal = document.querySelector('#gameOverModal');
			const finalScoreElt = document.querySelector('#final-score');

			function init() {
					const savedUsername = localStorage.getItem('username');
					if (savedUsername) {
							usernameDisplay.innerHTML = `Welcome, ${savedUsername}!`;
					} else {
							window.location.href = 'register.html';
					}
					// Set event listeners for level buttons
					easyBtn.addEventListener('click', setLevel);
					mediumBtn.addEventListener('click', setLevel);
					hardBtn.addEventListener('click', setLevel);
					wordInput.addEventListener('input', checkWord);
			}

			function setLevel(e) {
					currentLevel = levels[e.target.id];
					seconds.innerHTML = currentLevel;
					levelDisplay.innerHTML = capitalizeFirstLetter(e.target.id);
					time = currentLevel;
					generateWord();
					wordInput.focus();
					score = 0;
					scoreDisplay.innerHTML = score;
					timeDisplay.innerHTML = time;
					isPlaying = true;

					// Start the timer
					clearInterval(timer);
					timer = setInterval(countDown, 1000);
			}

			function generateWord() {
					const randomIndex = Math.floor(Math.random() * words.length);
					currentWord.innerHTML = words[randomIndex];
			}

			function checkWord() {
				if (wordInput.value === currentWord.innerHTML) {
						score++;
						scoreDisplay.innerHTML = score;
						wordInput.value = '';
						generateWord();
						time = currentLevel;
						timeDisplay.innerHTML = time;
						message.innerHTML = 'Good Job!';

						// Check high score
						const highScore = localStorage.getItem('highScore') || 0;
						if (score > highScore) {
								localStorage.setItem('highScore', score);
								highScoreElt.innerHTML = score;
						}
				}
			}

			function countDown() {
					if (time <= 0) {
							clearInterval(timer);
							endGame();
					} else {
							time--;
							timeDisplay.innerHTML = time;
					}
			}

			function endGame() {
					isPlaying = false;
					message.innerHTML = 'Game Over!';
					finalScoreElt.innerHTML = score;

					// Save score to local storage for leaderboard
					const highScores = JSON.parse(localStorage.getItem('highScores')) || [];
					const username = localStorage.getItem('username');
					
					// Check if user already has a score
					const existingUserIndex = highScores.findIndex(entry => entry.username === username);
					if (existingUserIndex >= 0) {
							// Update existing score if current score is higher
							if (highScores[existingUserIndex].score < score) {
									highScores[existingUserIndex].score = score;
							}
					} else {
							// Add new user score
							highScores.push({ username: username, score: score });
					}

					// Sort scores in descending order
					highScores.sort((a, b) => b.score - a.score);
					localStorage.setItem('highScores', JSON.stringify(highScores));

					gameOverModal.style.display = 'block';
				}

				function startAgain() {
						gameOverModal.style.display = 'none';
						setLevel({ target: { id: 'easy' } }); // Default to easy level for restarting
				}

				function closeGameOverModal() {
						gameOverModal.style.display = 'none';
				}

				function showModal() {
					// Display the score submitted modal
					const scoreSubmittedModal = document.createElement('div');
					scoreSubmittedModal.style.position = 'fixed';
					scoreSubmittedModal.style.top = '50%';
					scoreSubmittedModal.style.left = '50%';
					scoreSubmittedModal.style.transform = 'translate(-50%, -50%)';
					scoreSubmittedModal.style.background = '#004562';
					scoreSubmittedModal.style.padding = '20px';
					scoreSubmittedModal.style.borderRadius = '8px';
					scoreSubmittedModal.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
					scoreSubmittedModal.style.color = 'white';
					scoreSubmittedModal.style.textAlign = 'center';

					const message = document.createElement('h3');
					message.innerHTML = 'Score Submitted!';
					scoreSubmittedModal.appendChild(message);

					const checkLeaderboardButton = document.createElement('button');
					checkLeaderboardButton.innerHTML = 'Check Leaderboard';
					checkLeaderboardButton.style.marginTop = '10px';
					checkLeaderboardButton.onclick = function() {
							window.location.href = 'leaderboard.html'; // Redirect to leaderboard page
					};
					scoreSubmittedModal.appendChild(checkLeaderboardButton);

					const closeButton = document.createElement('button');
					closeButton.innerHTML = 'Close';
					closeButton.style.marginTop = '10px';
					closeButton.onclick = function() {
							document.body.removeChild(scoreSubmittedModal);
					};
					scoreSubmittedModal.appendChild(closeButton);

					document.body.appendChild(scoreSubmittedModal);

					// Update score in local storage
					const username = localStorage.getItem('username');
					let highScores = JSON.parse(localStorage.getItem('highScores')) || [];

					// Check if the user is already in the leaderboard
					const existingUser = highScores.find(entry => entry.username === username);

					if (existingUser) {
							// Update existing score if the new score is higher
							if (score > existingUser.score) {
									existingUser.score = score;
							}
					} else {
							// Add new user score
							highScores.push({ username: username, score: score });
					}

					// Sort scores in descending order
					highScores.sort((a, b) => b.score - a.score);

					// Save updated high scores
					localStorage.setItem('highScores', JSON.stringify(highScores));
				}
				console.log('High Scores:', highScores);
				console.log('User Entry:', existingUser);

				function closeModal() {
						const modal = document.querySelector('#usernameModal');
						modal.style.display = 'none';
				}

				function submitUsername() {
						const usernameInput = document.querySelector('#usernameInput').value;
						if (usernameInput.trim() !== '') {
								localStorage.setItem('username', usernameInput);
								usernameDisplay.innerHTML = `Welcome, ${usernameInput}!`;
								closeModal();
						}
				}

				function logout() {
						localStorage.removeItem('username');
						window.location.href = 'register.html';
				}

				function capitalizeFirstLetter(string) {
						return string.charAt(0).toUpperCase() + string.slice(1);
			}

  	</script>
  </body>
</html>
